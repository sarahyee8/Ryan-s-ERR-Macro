Sub BuildPrevAndCurrDictionaries()
    Dim wsPrev As Worksheet, wsCurr As Worksheet
    Dim lastRowPrev As Long, lastRowCurr As Long
    Dim i As Long
    Dim key As String, valueStr As String
    Dim prev As Object, curr As Object
    
    ' Create dictionaries
    Set prev = CreateObject("Scripting.Dictionary")
    Set curr = CreateObject("Scripting.Dictionary")
    
    ' Set worksheets
    Set wsPrev = ThisWorkbook.Sheets("PrevOpps")
    Set wsCurr = ThisWorkbook.Sheets("CurrOpps")
    
    ' Find last rows
    lastRowPrev = wsPrev.Cells(wsPrev.Rows.Count, "D").End(xlUp).Row
    lastRowCurr = wsCurr.Cells(wsCurr.Rows.Count, "D").End(xlUp).Row
    
    ' === Build prev dictionary ===
    For i = 2 To lastRowPrev
        key = Trim(wsPrev.Cells(i, "D").Value) & "_" & Trim(wsPrev.Cells(i, "P").Value)
        valueStr = Join(Array( _
                      ParseNumber(wsPrev.Cells(i, "S").Value), _
                      CleanString(wsPrev.Cells(i, "K").Value), _
                      CleanString(wsPrev.Cells(i, "W").Value), _
                      CleanString(wsPrev.Cells(i, "T").Value), _
                      CleanString(wsPrev.Cells(i, "O").Value), _
                      CleanString(wsPrev.Cells(i, "G").Value), _
                      CleanString(wsPrev.Cells(i, "AA").Value)), "|")
        prev(key) = valueStr
    Next i
    
    ' === Build curr dictionary ===
    For i = 2 To lastRowCurr
        key = Trim(wsCurr.Cells(i, "D").Value) & "_" & Trim(wsCurr.Cells(i, "P").Value)
        valueStr = Join(Array( _
                      ParseNumber(wsCurr.Cells(i, "S").Value), _
                      CleanString(wsCurr.Cells(i, "K").Value), _
                      CleanString(wsCurr.Cells(i, "W").Value), _
                      CleanString(wsCurr.Cells(i, "T").Value), _
                      CleanString(wsCurr.Cells(i, "O").Value), _
                      CleanString(wsCurr.Cells(i, "G").Value), _
                      CleanString(wsCurr.Cells(i, "AA").Value)), "|")
        curr(key) = valueStr
    Next i
    
    ' Call comparison procedure
    Call CheckDictionaries(prev, curr)
End Sub


Sub CheckDictionaries(prev As Object, curr As Object)
    Dim wsReport As Worksheet, wsPrev As Worksheet, wsCurr As Worksheet
    Dim wsCurrAct As Worksheet, wsPrevAct As Worksheet
    Dim dictKey As Variant
    Dim reportRow As Long
    Dim valsPrev As Variant, valsCurr As Variant
    Dim foundRow As Long
    Dim lastRowPrev As Long, lastRowCurr As Long, lastRowCurrAct As Long, lastRowPrevAct As Long
    Dim colCount As Long, changeCol As Long, reasonCol As Long
    Dim j As Long, maxIdx As Long
    Dim prevS As Double, currS As Double, changeVal As Double
    Dim prevVal As String, currVal As String
    Dim changeReason As String
    
    ' Source sheets
    Set wsPrev = ThisWorkbook.Sheets("PrevOpps")
    Set wsCurr = ThisWorkbook.Sheets("CurrOpps")
    Set wsCurrAct = ThisWorkbook.Sheets("CurrActuals")
    Set wsPrevAct = ThisWorkbook.Sheets("PrevActuals")
    colCount = wsPrev.Cells(1, wsPrev.Columns.Count).End(xlToLeft).Column
    
    ' Create or clear Report sheet
    On Error Resume Next
    Set wsReport = ThisWorkbook.Sheets("Report")
    On Error GoTo 0
    If wsReport Is Nothing Then
        Set wsReport = ThisWorkbook.Sheets.Add
        wsReport.Name = "Report"
    Else
        wsReport.Cells.Clear
    End If
    
    ' Copy headers
    wsPrev.Rows(1).Resize(1, colCount).Copy wsReport.Rows(1)
    changeCol = wsReport.Range("AP1").Column
    reasonCol = changeCol + 1
    wsReport.Cells(1, changeCol).Value = "Change in Amount"
    wsReport.Cells(1, reasonCol).Value = "Change Reason"
    wsReport.Cells(1, reasonCol + 1).Value = "Source Type"
    
    reportRow = 2
    lastRowPrev = wsPrev.Cells(wsPrev.Rows.Count, "D").End(xlUp).Row
    lastRowCurr = wsCurr.Cells(wsCurr.Rows.Count, "D").End(xlUp).Row
    lastRowCurrAct = wsCurrAct.Cells(wsCurrAct.Rows.Count, "T").End(xlUp).Row
    lastRowPrevAct = wsPrevAct.Cells(wsPrevAct.Rows.Count, "T").End(xlUp).Row
    
    ' === Step 1: Compare current vs previous forecasts ===
    For Each dictKey In curr.Keys
        If prev.Exists(dictKey) Then
            If prev(dictKey) <> curr(dictKey) Then
                foundRow = FindRowByKey(wsCurr, CStr(dictKey), lastRowCurr)
                If foundRow > 0 Then
                    wsReport.Rows(reportRow).Resize(1, colCount).Value = wsCurr.Rows(foundRow).Resize(1, colCount).Value
                    valsPrev = Split(prev(dictKey), "|")
                    valsCurr = Split(curr(dictKey), "|")
                    maxIdx = Application.Min(UBound(valsPrev), UBound(valsCurr))
                    changeReason = ""
                    For j = 0 To maxIdx
                        If j = 0 Then
                            prevVal = CStr(ParseNumber(valsPrev(j)))
                            currVal = CStr(ParseNumber(valsCurr(j)))
                        Else
                            prevVal = CleanString(valsPrev(j))
                            currVal = CleanString(valsCurr(j))
                        End If
                        If currVal <> prevVal Then
                            changeVal = ParseNumber(valsCurr(0)) - ParseNumber(valsPrev(0))
                            If j = 0 Then
                                wsReport.Cells(reportRow, changeCol).Value = changeVal
                                If changeVal <> 0 Then wsReport.Cells(reportRow, changeCol).Interior.Color = vbYellow
                            End If
                        End If
                    Next j
                    wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"
                    reportRow = reportRow + 1
                End If
            End If
        Else
            ' New forecast
            foundRow = FindRowByKey(wsCurr, CStr(dictKey), lastRowCurr)
            If foundRow > 0 Then
                wsReport.Rows(reportRow).Resize(1, colCount).Value = wsCurr.Rows(foundRow).Resize(1, colCount).Value
                valsCurr = Split(curr(dictKey), "|")
                currS = ParseNumber(valsCurr(0))
                wsReport.Cells(reportRow, changeCol).Value = currS
                If currS <> 0 Then wsReport.Cells(reportRow, changeCol).Interior.Color = vbYellow
                wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"
                reportRow = reportRow + 1
            End If
        End If
    Next dictKey
    
    ' === Step 2: Forecasts that dropped off (Prev but not Curr) ===
    Dim oppId As String, revStream As String, errUser As String
    Dim iAct As Long, lastColAct As Long
    Dim actAmt As Variant
    
    For Each dictKey In prev.Keys
        If Not curr.Exists(dictKey) Then
            foundRow = FindRowByKey(wsPrev, CStr(dictKey), lastRowPrev)
            If foundRow > 0 Then
                ' Copy fallen forecast
                wsReport.Rows(reportRow).Resize(1, colCount).Value = wsPrev.Rows(foundRow).Resize(1, colCount).Value
                wsReport.Rows(reportRow).Interior.Color = RGB(120, 120, 120)  ' grey row
                wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"
                
                ' Get prev forecast amount and mark as negative
                Dim prevAmt As Variant
                prevAmt = wsReport.Cells(reportRow, "X").Value
                If IsNumeric(prevAmt) Then
                    wsReport.Cells(reportRow, changeCol).Value = -ParseNumber(prevAmt)
                End If
                reportRow = reportRow + 1
                
                ' Add Actuals lines for fallen forecasts from CurrActuals
                oppId = Trim(wsPrev.Cells(foundRow, "D").Value)
                revStream = Trim(wsPrev.Cells(foundRow, "P").Value)
                errUser = Trim(wsPrev.Cells(foundRow, "K").Value)
                
                For iAct = 2 To lastRowCurrAct
                    If (Trim(wsCurrAct.Cells(iAct, "T").Value) & "_" & Trim(wsCurrAct.Cells(iAct, "AI").Value) = oppId & "_" & revStream) _
                    Or (Trim(wsCurrAct.Cells(iAct, "AD").Value) & "_" & Trim(wsCurrAct.Cells(iAct, "AI").Value) = errUser & "_" & revStream) Then
                        lastColAct = wsCurrAct.Cells(iAct, wsCurrAct.Columns.Count).End(xlToLeft).Column
                        wsReport.Cells(reportRow, 1).Resize(1, lastColAct - 19 + 1).Value = wsCurrAct.Cells(iAct, 20).Resize(1, lastColAct - 19 + 1).Value
                        actAmt = wsReport.Cells(reportRow, "X").Value
                        If IsNumeric(actAmt) Then
                            wsReport.Cells(reportRow, changeCol).Value = ParseNumber(actAmt)
                            If ParseNumber(actAmt) <> 0 Then wsReport.Cells(reportRow, changeCol).Interior.Color = vbYellow
                        End If
                        wsReport.Cells(reportRow, reasonCol + 1).Value = "Actuals"
                        reportRow = reportRow + 1
                    End If
                Next iAct
            End If
        End If
    Next dictKey
    
    ' === Step 3: Compare CurrActuals vs PrevActuals ===
    Dim pulledKeys As Object
    Set pulledKeys = CreateObject("Scripting.Dictionary")
    
    ' Mark rows already pulled into Report
    Dim r As Long
    For r = 2 To reportRow - 1
        Dim reportOppID As String, reportRev As String
        reportOppID = Trim(CStr(wsReport.Cells(r, "D").Value))
        reportRev = Trim(CStr(wsReport.Cells(r, "P").Value))
        pulledKeys(reportOppID & "_" & reportRev & "_Actuals") = True
    Next r
    
    ' CurrActuals
    For r = 2 To lastRowCurrAct
        Dim currOppID As String, currRev As String, keyAct As String
        currOppID = Trim(wsCurrAct.Cells(r, "T").Value)
        currRev = Trim(wsCurrAct.Cells(r, "AI").Value)
        keyAct = currOppID & "_" & currRev & "_Actuals"
        
        If pulledKeys.Exists(keyAct) Then GoTo NextCurrAct
        
        ' Find match in PrevActuals
        Dim prevRow As Long, prevAK As Variant, currAK As Variant
        prevRow = 0
        For prevRow = 2 To lastRowPrevAct
            If Trim(wsPrevAct.Cells(prevRow, "T").Value) = currOppID And _
               Trim(wsPrevAct.Cells(prevRow, "AI").Value) = currRev Then Exit For
        Next prevRow
        If prevRow > lastRowPrevAct Then prevRow = 0
        
        currAK = wsCurrAct.Cells(r, "AK").Value
        
        If prevRow > 0 Then
            prevAK = wsPrevAct.Cells(prevRow, "AK").Value
            If currAK <> prevAK Then
                ' Bring in both
                Dim lastCol As Long
                lastCol = wsPrevAct.Cells(prevRow, wsPrevAct.Columns.Count).End(xlToLeft).Column
                wsReport.Cells(reportRow, 1).Resize(1, lastCol - 20 + 1).Value = wsPrevAct.Cells(prevRow, 20).Resize(1, lastCol - 20 + 1).Value
                wsReport.Cells(reportRow, changeCol).Value = 0
                wsReport.Cells(reportRow, reasonCol).Value = "Actuals AK Change (Prev)"
                wsReport.Cells(reportRow, reasonCol + 1).Value = "PrevActuals"
                pulledKeys(keyAct) = True
                reportRow = reportRow + 1
                
                lastCol = wsCurrAct.Cells(r, wsCurrAct.Columns.Count).End(xlToLeft).Column
                wsReport.Cells(reportRow, 1).Resize(1, lastCol - 20 + 1).Value = wsCurrAct.Cells(r, 20).Resize(1, lastCol - 20 + 1).Value
                wsReport.Cells(reportRow, changeCol).Value = ParseNumber(currAK) - ParseNumber(prevAK)
                wsReport.Cells(reportRow, reasonCol).Value = "Actuals AK Change (Curr)"
                wsReport.Cells(reportRow, reasonCol + 1).Value = "CurrActuals"
                pulledKeys(keyAct) = True
                reportRow = reportRow + 1
            End If
        Else
            ' New in CurrActuals only
            lastCol = wsCurrAct.Cells(r, wsCurrAct.Columns.Count).End(xlToLeft).Column
            wsReport.Cells(reportRow, 1).Resize(1, lastCol - 20 + 1).Value = wsCurrAct.Cells(r, 20).Resize(1, lastCol - 20 + 1).Value
            wsReport.Cells(reportRow, changeCol).Value = ParseNumber(currAK)
            wsReport.Cells(reportRow, reasonCol).Value = "New Actuals"
            wsReport.Cells(reportRow, reasonCol + 1).Value = "CurrActuals"
            pulledKeys(keyAct) = True
            reportRow = reportRow + 1
        End If
NextCurrAct:
    Next r
    
    ' PrevActuals missing in CurrActuals
    For r = 2 To lastRowPrevAct
        Dim prevOppID As String, prevRev As String, keyPrevAct As String
        prevOppID = Trim(wsPrevAct.Cells(r, "T").Value)
        prevRev = Trim(wsPrevAct.Cells(r, "AI").Value)
        keyPrevAct = prevOppID & "_" & prevRev & "_Actuals"
        
        If pulledKeys.Exists(keyPrevAct) Then GoTo NextPrevAct
        
        ' Row missing in CurrActuals
        lastCol = wsPrevAct.Cells(r, wsPrevAct.Columns.Count).End(xlToLeft).Column
        wsReport.Cells(reportRow, 1).Resize(1, lastCol - 20 + 1).Value = wsPrevAct.Cells(r, 20).Resize(1, lastCol - 20 + 1).Value
        wsReport.Cells(reportRow, changeCol).Value = -ParseNumber(wsPrevAct.Cells(r, "AK").Value)
        wsReport.Cells(reportRow, reasonCol).Value = "Removed Actuals"
        wsReport.Cells(reportRow, reasonCol + 1).Value = "PrevActuals"
        pulledKeys(keyPrevAct) = True
        reportRow = reportRow + 1
NextPrevAct:
    Next r
    
    wsReport.Columns.AutoFit
End Sub


Function FindRowByKey(ws As Worksheet, ByVal keyText As String, ByVal lastRow As Long) As Long
    Dim i As Long, testKey As String
    For i = 2 To lastRow
        testKey = Trim$(CStr(ws.Cells(i, "D").Value)) & "_" & Trim$(CStr(ws.Cells(i, "P").Value))
        If testKey = keyText Then
            FindRowByKey = i
            Exit Function
        End If
    Next i
    FindRowByKey = 0
End Function


Private Function ParseNumber(ByVal v As Variant) As Double
    Dim s As String
    s = Trim$(CStr(v))
    If s = "" Or UCase$(s) = "N/A" Then
        ParseNumber = 0
    Else
        s = Replace(s, ",", "")
        s = Replace(s, "$", "")
        On Error Resume Next
        ParseNumber = CDbl(s)
        On Error GoTo 0
    End If
End Function


Private Function CleanString(ByVal s As Variant) As String
    Dim temp As String
    temp = Trim(CStr(s))
    temp = Replace(temp, Chr(160), "")
    CleanString = UCase(temp)
End Function
