Sub BuildPrevAndCurrDictionaries()
    Dim wsPrev As Worksheet, wsCurr As Worksheet
    Dim lastRowPrev As Long, lastRowCurr As Long
    Dim i As Long
    Dim key As String, valueStr As String
    Dim prev As Object, curr As Object
    
    ' Create dictionaries
    Set prev = CreateObject("Scripting.Dictionary")
    Set curr = CreateObject("Scripting.Dictionary")
    
    ' Set worksheets
    Set wsPrev = ThisWorkbook.Sheets("PrevOpps")
    Set wsCurr = ThisWorkbook.Sheets("CurrOpps")
    
    ' Find last rows
    lastRowPrev = wsPrev.Cells(wsPrev.Rows.Count, "D").End(xlUp).Row
    lastRowCurr = wsCurr.Cells(wsCurr.Rows.Count, "D").End(xlUp).Row
    
    ' === Build prev dictionary ===
    For i = 2 To lastRowPrev
        key = Trim(wsPrev.Cells(i, "D").Value) & "_" & Trim(wsPrev.Cells(i, "P").Value)
        valueStr = Join(Array( _
                      ParseNumber(wsPrev.Cells(i, "S").Value), _
                      CleanString(wsPrev.Cells(i, "K").Value), _
                      CleanString(wsPrev.Cells(i, "W").Value), _
                      CleanString(wsPrev.Cells(i, "T").Value), _
                      CleanString(wsPrev.Cells(i, "O").Value), _
                      CleanString(wsPrev.Cells(i, "G").Value), _
                      CleanString(wsPrev.Cells(i, "AA").Value)), "|")
        prev(key) = valueStr
    Next i
    
    ' === Build curr dictionary ===
    For i = 2 To lastRowCurr
        key = Trim(wsCurr.Cells(i, "D").Value) & "_" & Trim(wsCurr.Cells(i, "P").Value)
        valueStr = Join(Array( _
                      ParseNumber(wsCurr.Cells(i, "S").Value), _
                      CleanString(wsCurr.Cells(i, "K").Value), _
                      CleanString(wsCurr.Cells(i, "W").Value), _
                      CleanString(wsCurr.Cells(i, "T").Value), _
                      CleanString(wsCurr.Cells(i, "O").Value), _
                      CleanString(wsCurr.Cells(i, "G").Value), _
                      CleanString(wsCurr.Cells(i, "AA").Value)), "|")
        curr(key) = valueStr
    Next i
    
    ' Call comparison procedure
    Call CheckDictionaries(prev, curr)
End Sub


Sub CheckDictionaries(prev As Object, curr As Object)
    Dim wsReport As Worksheet, wsPrev As Worksheet, wsCurr As Worksheet
    Dim wsCurrAct As Worksheet, wsPrevAct As Worksheet
    Dim dictKey As Variant
    Dim reportRow As Long
    Dim valsPrev As Variant, valsCurr As Variant
    Dim foundRow As Long
    Dim lastRowPrev As Long, lastRowCurr As Long, lastRowCurrAct As Long
    Dim colCount As Long, changeCol As Long, reasonCol As Long
    Dim j As Long, maxIdx As Long
    Dim prevS As Double, currS As Double, changeVal As Double
    Dim prevVal As String, currVal As String
    Dim changeReason As String
    
    ' Source sheets
    Set wsPrev = ThisWorkbook.Sheets("PrevOpps")
    Set wsCurr = ThisWorkbook.Sheets("CurrOpps")
    Set wsCurrAct = ThisWorkbook.Sheets("CurrActuals")
    Set wsPrevAct = ThisWorkbook.Sheets("PrevActuals")
    colCount = wsPrev.Cells(1, wsPrev.Columns.Count).End(xlToLeft).Column
    
    ' Create or clear Report sheet
    On Error Resume Next
    Set wsReport = ThisWorkbook.Sheets("Report")
    On Error GoTo 0
    If wsReport Is Nothing Then
        Set wsReport = ThisWorkbook.Sheets.Add
        wsReport.Name = "Report"
    Else
        wsReport.Cells.Clear
    End If
    
    ' Copy headers
    wsPrev.Rows(1).Resize(1, colCount).Copy wsReport.Rows(1)
    changeCol = wsReport.Range("AP1").Column
    reasonCol = changeCol + 1
    wsReport.Cells(1, changeCol).Value = "Change in Amount"
    wsReport.Cells(1, reasonCol).Value = "Change Reason"
    wsReport.Cells(1, reasonCol + 1).Value = "Source Type"
    
    reportRow = 2
    lastRowPrev = wsPrev.Cells(wsPrev.Rows.Count, "D").End(xlUp).Row
    lastRowCurr = wsCurr.Cells(wsCurr.Rows.Count, "D").End(xlUp).Row
    lastRowCurrAct = wsCurrAct.Cells(wsCurrAct.Rows.Count, "T").End(xlUp).Row
    
    ' Dictionary to track actuals already added to report (to avoid duplicates)
    Dim dictSeenActuals As Object
    Set dictSeenActuals = CreateObject("Scripting.Dictionary")
    
    ' === Step 1: Compare current vs previous forecasts ===
    For Each dictKey In curr.Keys
        If prev.Exists(dictKey) Then
            If prev(dictKey) <> curr(dictKey) Then
                foundRow = FindRowByKey(wsCurr, CStr(dictKey), lastRowCurr)
                If foundRow > 0 Then
                    wsReport.Rows(reportRow).Resize(1, colCount).Value = wsCurr.Rows(foundRow).Resize(1, colCount).Value
                    valsPrev = Split(prev(dictKey), "|")
                    valsCurr = Split(curr(dictKey), "|")
                    maxIdx = Application.Min(UBound(valsPrev), UBound(valsCurr))
                    
                    ' Initialize change reason
                    changeReason = ""
                    
                    ' Compare tracked fields and construct changeReason + highlight specific columns
                    For j = 0 To maxIdx
                        If j = 0 Then
                            prevVal = CStr(ParseNumber(valsPrev(j)))
                            currVal = CStr(ParseNumber(valsCurr(j)))
                        Else
                            prevVal = CleanString(valsPrev(j))
                            currVal = CleanString(valsCurr(j))
                        End If
                        
                        If currVal <> prevVal Then
                            ' compute amount change once (based on amount fields)
                            prevS = ParseNumber(valsPrev(0))
                            currS = ParseNumber(valsCurr(0))
                            changeVal = currS - prevS
                            
                            Select Case j
                                Case 0
                                    ' Amount field changed
                                    wsReport.Cells(reportRow, 19).Interior.Color = vbYellow
                                    
                                    ' If Risk Status (index 2) unchanged, call it a Risk Amount Change
                                    If CleanString(valsCurr(2)) = CleanString(valsPrev(2)) Then
                                        changeReason = "Risk Amount Change: " & valsCurr(1) & " " & _
                                                       IIf(changeVal >= 0, "+$", "-$") & Format(Abs(changeVal), "#,##0.00")
                                    End If
                                Case 1
                                    ' AE / Risk Owner field changed
                                    wsReport.Cells(reportRow, 23).Interior.Color = vbYellow
                                    
                                    ' If Risk Status changed, call it Risk Status Change and include prev->curr
                                    If CleanString(valsCurr(2)) <> CleanString(valsPrev(2)) Then
                                        changeReason = "Risk Status Change: " & valsCurr(1) & " " & _
                                                       IIf(changeVal >= 0, "+$", "-$") & Format(Abs(changeVal), "#,##0.00") & _
                                                       " (" & valsPrev(2) & " to " & valsCurr(2) & ")"
                                    End If
                                Case 2
                                    wsReport.Cells(reportRow, 20).Interior.Color = vbYellow
                                Case 3
                                    wsReport.Cells(reportRow, 15).Interior.Color = vbYellow
                                Case 4
                                    wsReport.Cells(reportRow, 7).Interior.Color = vbYellow
                                Case 5
                                    wsReport.Cells(reportRow, 27).Interior.Color = vbYellow
                                Case Else
                                    ' do nothing for other indices
                            End Select
                        End If
                    Next j
                    
                    ' Write Change in Amount and highlight if non-zero
                    currS = ParseNumber(valsCurr(0))
                    prevS = ParseNumber(valsPrev(0))
                    changeVal = currS - prevS
                    wsReport.Cells(reportRow, changeCol).Value = changeVal
                    If changeVal <> 0 Then wsReport.Cells(reportRow, changeCol).Interior.Color = vbYellow
                    
                    ' Write constructed Change Reason (if any)
                    wsReport.Cells(reportRow, reasonCol).Value = changeReason
                    
                    ' Mark source
                    wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"
                    
                    reportRow = reportRow + 1
                End If
            End If
        Else
            ' New forecast
            foundRow = FindRowByKey(wsCurr, CStr(dictKey), lastRowCurr)
            If foundRow > 0 Then
                wsReport.Rows(reportRow).Resize(1, colCount).Value = wsCurr.Rows(foundRow).Resize(1, colCount).Value
                valsCurr = Split(curr(dictKey), "|")
                currS = ParseNumber(valsCurr(0))
                wsReport.Cells(reportRow, changeCol).Value = currS
                If currS <> 0 Then wsReport.Cells(reportRow, changeCol).Interior.Color = vbYellow
                wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"
                reportRow = reportRow + 1
            End If
        End If
    Next dictKey
    
    ' === Step 2: Forecasts that dropped off ===
    For Each dictKey In prev.Keys
        If Not curr.Exists(dictKey) Then
            foundRow = FindRowByKey(wsPrev, CStr(dictKey), lastRowPrev)
            If foundRow > 0 Then
                ' Copy fallen forecast
                wsReport.Rows(reportRow).Resize(1, colCount).Value = wsPrev.Rows(foundRow).Resize(1, colCount).Value
                wsReport.Rows(reportRow).Interior.Color = RGB(120, 120, 120)  ' grey row
                wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"
                
                ' Get prev forecast amount and mark as negative (no yellow fill)
                Dim prevAmt As Variant
                prevAmt = wsReport.Cells(reportRow, "X").Value
                If IsNumeric(prevAmt) Then
                    wsReport.Cells(reportRow, changeCol).Value = -ParseNumber(prevAmt)
                End If
                
                reportRow = reportRow + 1
                
                ' Add Actuals lines (still yellow highlight for those)
                Dim oppId As String, revStream As String, errUser As String
                Dim iAct As Long, lastColAct As Long
                Dim actAmt As Variant
                oppId = Trim(wsPrev.Cells(foundRow, "D").Value)
                revStream = Trim(wsPrev.Cells(foundRow, "P").Value)
                errUser = Trim(wsPrev.Cells(foundRow, "K").Value)
                
                For iAct = 2 To lastRowCurrAct
                    If (Trim(wsCurrAct.Cells(iAct, "T").Value) & "_" & Trim(wsCurrAct.Cells(iAct, "AI").Value) = oppId & "_" & revStream) _
                    Or (Trim(wsCurrAct.Cells(iAct, "AD").Value) & "_" & Trim(wsCurrAct.Cells(iAct, "AI").Value) = errUser & "_" & revStream) Then
                        lastColAct = wsCurrAct.Cells(iAct, wsCurrAct.Columns.Count).End(xlToLeft).Column
                        ' copy actuals starting at col 20 of CurrActuals into Report starting at col A
                        wsReport.Cells(reportRow, 1).Resize(1, lastColAct - 19 + 1).Value = _
                            wsCurrAct.Cells(iAct, 20).Resize(1, lastColAct - 19 + 1).Value
                        actAmt = wsReport.Cells(reportRow, "X").Value
                        If IsNumeric(actAmt) Then
                            wsReport.Cells(reportRow, changeCol).Value = ParseNumber(actAmt)
                            If ParseNumber(actAmt) <> 0 Then wsReport.Cells(reportRow, changeCol).Interior.Color = vbYellow
                        End If
                        wsReport.Cells(reportRow, reasonCol + 1).Value = "Actuals"
                        
                        ' mark this actual as seen to avoid duplication in step 3
                        Dim seenKey As String
                        seenKey = Trim(CStr(wsReport.Cells(reportRow, "T").Value)) & "|" & Trim(CStr(wsReport.Cells(reportRow, "AI").Value)) & "|" & Trim(CStr(wsReport.Cells(reportRow, "AK").Value))
                        If Not dictSeenActuals.Exists(seenKey) Then dictSeenActuals.Add seenKey, True
                        
                        reportRow = reportRow + 1
                    End If
                Next iAct
            End If
        End If
    Next dictKey
    
    ' === Step 3: Compare CurrActuals vs PrevActuals (AK changes) ===
    Dim lastPrevA As Long, lastCurrA As Long
    Dim dictPrevA As Object
    Set dictPrevA = CreateObject("Scripting.Dictionary")
    Dim rPrev As Long
    Dim oppID As String, revStream As String
    Dim AKprev As Variant, AKcurr As Variant
    Dim amountChange As Double
    Dim r As Long
    Dim lastReportRow As Long
    
    lastPrevA = wsPrevAct.Cells(wsPrevAct.Rows.Count, "T").End(xlUp).Row
    lastCurrA = wsCurrAct.Cells(wsCurrAct.Rows.Count, "T").End(xlUp).Row
    lastReportRow = reportRow - 1
    
    ' Build lookup for PrevActuals using OppID|RevStream and also ErrUser|RevStream
    For i = 2 To lastPrevA
        oppID = Trim(wsPrevAct.Cells(i, "T").Value)
        revStream = Trim(wsPrevAct.Cells(i, "AI").Value)
        If oppID <> "" Or Trim(wsPrevAct.Cells(i, "AD").Value) <> "" Then
            ' primary key
            If oppID <> "" Then
                key = oppID & "|" & revStream
                If Not dictPrevA.Exists(key) Then dictPrevA.Add key, i
            End If
            ' secondary key using ErrUser (AD)
            If Trim(wsPrevAct.Cells(i, "AD").Value) <> "" Then
                key = Trim(wsPrevAct.Cells(i, "AD").Value) & "|" & revStream
                If Not dictPrevA.Exists(key) Then dictPrevA.Add key, i
            End If
        End If
    Next i
    
    ' Loop current actuals and compare AK
    For i = 2 To lastCurrA
        oppID = Trim(wsCurrAct.Cells(i, "T").Value)
        revStream = Trim(wsCurrAct.Cells(i, "AI").Value)
        If oppID = "" And Trim(wsCurrAct.Cells(i, "AD").Value) = "" Then GoTo NextCurrRow
        
        ' try oppID key first
        key = oppID & "|" & revStream
        If Not dictPrevA.Exists(key) Then
            ' try ErrUser key
            key = Trim(wsCurrAct.Cells(i, "AD").Value) & "|" & revStream
        End If
        
        If dictPrevA.Exists(key) Then
            rPrev = dictPrevA(key)
            AKcurr = wsCurrAct.Cells(i, "AK").Value
            AKprev = wsPrevAct.Cells(rPrev, "AK").Value
            
            ' only act if AK values are different (treat blanks and non-numeric carefully)
            If Trim(CStr(AKcurr)) <> Trim(CStr(AKprev)) Then
                ' compute numeric difference when possible
                If IsNumeric(AKcurr) And IsNumeric(AKprev) Then
                    amountChange = CDbl(AKcurr) - CDbl(AKprev)
                Else
                    ' fallback: try convert, else 0
                    On Error Resume Next
                    amountChange = CDbl(AKcurr) - CDbl(AKprev)
                    If Err.Number <> 0 Then amountChange = 0
                    On Error GoTo 0
                End If
                
                ' build seenKey for current actual (opportunity + revstream + AKcurr)
                Dim seenKeyCurr As String, seenKeyPrev As String
                seenKeyCurr = Trim(CStr(oppID)) & "|" & Trim(CStr(revStream)) & "|" & Trim(CStr(AKcurr))
                seenKeyPrev = Trim(CStr(oppID)) & "|" & Trim(CStr(revStream)) & "|" & Trim(CStr(AKprev))
                
                ' If neither Prev nor Curr actual already added to report, append them
                If Not dictSeenActuals.Exists(seenKeyCurr) And Not dictSeenActuals.Exists(seenKeyPrev) Then
                    ' Append PrevActuals row (columns T:BH) starting at col A
                    lastReportRow = lastReportRow + 1
                    wsPrevAct.Range("T" & rPrev & ":BH" & rPrev).Copy
                    wsReport.Cells(lastReportRow, "A").PasteSpecial xlPasteValues
                    ' mark change in amount on prev row as negative amountChange
                    wsReport.Cells(lastReportRow, changeCol).Value = -amountChange
                    ' reason and source
                    wsReport.Cells(lastReportRow, reasonCol).Value = "REMOVED/UPDATED ACTUAL (Prev)"
                    wsReport.Cells(lastReportRow, reasonCol + 1).Value = "Actuals"
                    ' mark seen
                    If Not dictSeenActuals.Exists(seenKeyPrev) Then dictSeenActuals.Add seenKeyPrev, True
                    ' optional shading for removed-like prev row
                    wsReport.Rows(lastReportRow).Interior.Color = RGB(220, 220, 220)
                    
                    ' Append CurrActuals row (columns T:BH) starting at col A
                    lastReportRow = lastReportRow + 1
                    wsCurrAct.Range("T" & i & ":BH" & i).Copy
                    wsReport.Cells(lastReportRow, "A").PasteSpecial xlPasteValues
                    ' mark change in amount on curr row as positive amountChange
                    wsReport.Cells(lastReportRow, changeCol).Value = amountChange
                    If amountChange <> 0 Then wsReport.Cells(lastReportRow, changeCol).Interior.Color = vbYellow
                    ' reason and source
                    wsReport.Cells(lastReportRow, reasonCol).Value = "ERR GIDB Forecast changed: " & Trim(CStr(AKprev)) & " -> " & Trim(CStr(AKcurr))
                    wsReport.Cells(lastReportRow, reasonCol + 1).Value = "Actuals"
                    ' mark seen
                    If Not dictSeenActuals.Exists(seenKeyCurr) Then dictSeenActuals.Add seenKeyCurr, True
                End If
            End If
        End If
NextCurrRow:
    Next i
    
    ' advance reportRow in case further logic expects it
    reportRow = lastReportRow + 1
    
    wsReport.Columns.AutoFit
End Sub


Function FindRowByKey(ws As Worksheet, ByVal keyText As String, ByVal lastRow As Long) As Long
    Dim i As Long, testKey As String
    For i = 2 To lastRow
        testKey = Trim$(CStr(ws.Cells(i, "D").Value)) & "_" & Trim$(CStr(ws.Cells(i, "P").Value))
        If testKey = keyText Then
            FindRowByKey = i
            Exit Function
        End If
    Next i
    FindRowByKey = 0
End Function


Private Function ParseNumber(ByVal v As Variant) As Double
    Dim s As String
    s = Trim$(CStr(v))
    If s = "" Or UCase$(s) = "N/A" Then
        ParseNumber = 0
    Else
        s = Replace(s, ",", "")
        s = Replace(s, "$", "")
        On Error Resume Next
        ParseNumber = CDbl(s)
        On Error GoTo 0
    End If
End Function


Private Function CleanString(ByVal s As Variant) As String
    Dim temp As String
    temp = Trim(CStr(s))
    temp = Replace(temp, Chr(160), "")
    CleanString = UCase(temp)
End Function
