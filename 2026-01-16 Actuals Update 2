Sub BuildPrevAndCurrDictionaries()
    Dim wsPrev As Worksheet, wsCurr As Worksheet
    Dim lastRowPrev As Long, lastRowCurr As Long
    Dim i As Long
    Dim key As String, valueStr As String
    Dim prev As Object, curr As Object
    
    ' Create dictionaries
    Set prev = CreateObject("Scripting.Dictionary")
    Set curr = CreateObject("Scripting.Dictionary")
    
    ' Set worksheets
    Set wsPrev = ThisWorkbook.Sheets("PrevOpps")
    Set wsCurr = ThisWorkbook.Sheets("CurrOpps")
    
    ' Find last rows
    lastRowPrev = wsPrev.Cells(wsPrev.Rows.Count, "D").End(xlUp).Row
    lastRowCurr = wsCurr.Cells(wsCurr.Rows.Count, "D").End(xlUp).Row
    
    ' === Build prev dictionary ===
    For i = 2 To lastRowPrev
        key = Trim(wsPrev.Cells(i, "D").Value) & "_" & Trim(wsPrev.Cells(i, "P").Value)
        valueStr = Join(Array( _
                      ParseNumber(wsPrev.Cells(i, "S").Value), _
                      CleanString(wsPrev.Cells(i, "K").Value), _
                      CleanString(wsPrev.Cells(i, "W").Value), _
                      CleanString(wsPrev.Cells(i, "T").Value), _
                      CleanString(wsPrev.Cells(i, "O").Value), _
                      CleanString(wsPrev.Cells(i, "G").Value), _
                      CleanString(wsPrev.Cells(i, "AA").Value)), "|")
        prev(key) = valueStr
    Next i
    
    ' === Build curr dictionary ===
    For i = 2 To lastRowCurr
        key = Trim(wsCurr.Cells(i, "D").Value) & "_" & Trim(wsCurr.Cells(i, "P").Value)
        valueStr = Join(Array( _
                      ParseNumber(wsCurr.Cells(i, "S").Value), _
                      CleanString(wsCurr.Cells(i, "K").Value), _
                      CleanString(wsCurr.Cells(i, "W").Value), _
                      CleanString(wsCurr.Cells(i, "T").Value), _
                      CleanString(wsCurr.Cells(i, "O").Value), _
                      CleanString(wsCurr.Cells(i, "G").Value), _
                      CleanString(wsCurr.Cells(i, "AA").Value)), "|")
        curr(key) = valueStr
    Next i
    
    AddOppIdHyperlinks_CurrPrev_MidInsert

    ' Call comparison procedure
    Call CheckDictionaries(prev, curr)
End Sub

Sub CheckDictionaries(prev As Object, curr As Object)
    Dim wsReport As Worksheet, wsPrev As Worksheet, wsCurr As Worksheet
    Dim wsCurrAct As Worksheet
    Dim dictKey As Variant
    Dim reportRow As Long
    Dim valsPrev As Variant, valsCurr As Variant
    Dim foundRow As Long
    Dim lastRowPrev As Long, lastRowCurr As Long, lastRowCurrAct As Long
    Dim colCount As Long, changeCol As Long, reasonCol As Long
    Dim j As Long, maxIdx As Long
    Dim prevS As Double, currS As Double, changeVal As Double
    Dim prevVal As String, currVal As String
    Dim changedCount As Long, newCount As Long, removedCount As Long
    Dim changeReason As String

    ' Initialize counters
    changedCount = 0: newCount = 0: removedCount = 0

    ' Source sheets
    Set wsPrev = ThisWorkbook.Sheets("PrevOpps")
    Set wsCurr = ThisWorkbook.Sheets("CurrOpps")
    Set wsCurrAct = ThisWorkbook.Sheets("CurrActuals")
    colCount = wsPrev.Cells(1, wsPrev.Columns.Count).End(xlToLeft).Column

    ' Create or clear Report sheet
    On Error Resume Next
    Set wsReport = ThisWorkbook.Sheets("Report")
    On Error GoTo 0
    If wsReport Is Nothing Then
        Set wsReport = ThisWorkbook.Sheets.Add
        wsReport.Name = "Report"
    Else
        wsReport.Cells.Clear
    End If

    ' Copy headers
    wsPrev.Rows(1).Resize(1, colCount).Copy wsReport.Rows(1)
    changeCol = wsReport.Range("AP1").Column
    reasonCol = changeCol + 1
    wsReport.Cells(1, changeCol).Value = "Change in Amount"
    wsReport.Cells(1, reasonCol).Value = "Change Reason"
    wsReport.Cells(1, reasonCol + 1).Value = "Source Type"

    reportRow = 2
    lastRowPrev = wsPrev.Cells(wsPrev.Rows.Count, "D").End(xlUp).Row
    lastRowCurr = wsCurr.Cells(wsCurr.Rows.Count, "D").End(xlUp).Row

    ' === CHANGED: Use AI for last row because T (Opp ID) can contain blanks ===
    lastRowCurrAct = wsCurrAct.Cells(wsCurrAct.Rows.Count, "AI").End(xlUp).Row

    ' === Step 1: Compare current vs previous forecasts ===
    For Each dictKey In curr.Keys
        If prev.Exists(dictKey) Then

            If prev(dictKey) <> curr(dictKey) Then
                foundRow = FindRowByKey(wsCurr, CStr(dictKey), lastRowCurr)
                If foundRow > 0 Then
                    wsReport.Rows(reportRow).Resize(1, colCount).Value = wsCurr.Rows(foundRow).Resize(1, colCount).Value
                    ApplyOppHyperlinkToCell wsReport.Cells(reportRow, "D")
                    valsPrev = Split(prev(dictKey), "|")
                    valsCurr = Split(curr(dictKey), "|")
                    maxIdx = Application.Min(UBound(valsPrev), UBound(valsCurr))

                    ' Initialize change reason
                    changeReason = ""

                    ' Compare tracked fields and construct changeReason + highlight specific columns
                    For j = 0 To maxIdx
                        If j = 0 Then
                            prevVal = CStr(ParseNumber(valsPrev(j)))
                            currVal = CStr(ParseNumber(valsCurr(j)))
                        Else
                            prevVal = CleanString(valsPrev(j))
                            currVal = CleanString(valsCurr(j))
                        End If

                        If currVal <> prevVal Then
                            ' === CHANGED: compute amount change once per detected change ===
                            prevS = ParseNumber(valsPrev(0))
                            currS = ParseNumber(valsCurr(0))
                            changeVal = prevS - currS

                            Select Case j

                                Case 0
                                    ' === Risk Amount (S) changed ===
                                    wsReport.Cells(reportRow, 19).Interior.Color = vbYellow  ' Column S

                                    If CleanString(valsCurr(2)) = CleanString(valsPrev(2)) Then
                                        changeReason = "Risk Amount Change: " & valsCurr(1) & " " & _
                                                        IIf(changeVal >= 0, "+$", "-$") & _
                                                        Format(Abs(changeVal), "#,##0.00")
                                    End If

                                Case 2
                                    ' === Risk Status / Cancellation Probability (W) changed ===
                                    wsReport.Cells(reportRow, 23).Interior.Color = vbYellow  ' Column W

                                    If CleanString(valsCurr(2)) <> CleanString(valsPrev(2)) Then
                                        changeReason = "Risk Status Change: " & valsCurr(1) & " " & _
                                                        IIf(changeVal >= 0, "+$", "-$") & _
                                                        Format(Abs(changeVal), "#,##0.00") & _
                                                        " (" & valsPrev(2) & " to " & valsCurr(2) & ")"
                                    End If

                                Case 4
                                    ' === Sales Group (O) changed ===
                                    wsReport.Cells(reportRow, 15).Interior.Color = vbYellow  ' Column O

                                    If CleanString(valsCurr(4)) <> CleanString(valsPrev(4)) Then
                                        changeReason = "Sales Group Change: " & valsCurr(1) & _
                                                        " (" & valsPrev(4) & " to " & valsCurr(4) & ")"
                                    End If

                                Case 5
                                    ' === ERR Territory (T) changed ===
                                    wsReport.Cells(reportRow, 7).Interior.Color = vbYellow   ' Column G (ERR Territory display)

                                    If CleanString(valsCurr(3)) <> CleanString(valsPrev(3)) Then
                                        changeReason = "ERR Territory Change: " & valsCurr(1) & _
                                                        " (" & valsPrev(3) & " to " & valsCurr(3) & ")"
                                    End If

                                Case 6
                                    ' === Year / Quarter / Month (AA) changed ===
                                    wsReport.Cells(reportRow, 27).Interior.Color = vbYellow  ' Column AA

                                    Dim rawString As String
                                    Dim yr As Integer, qtr As Integer, mn As Integer
                                    Dim checkDate As Date

                                    rawString = wsReport.Cells(reportRow, 27).Value
                                    Dim parts() As String
                                    parts = Split(rawString, " ")

                                    yr = CInt(parts(0))
                                    qtr = CInt(parts(2))
                                    mn = CInt(parts(4))

                                    checkDate = DateSerial(yr, mn, 1)

                                    If Year(checkDate) < Year(Date) Or _
                                        (Year(checkDate) = Year(Date) And Month(checkDate) < Month(Date)) Then

                                        changeReason = "Opportunity moved over months: (" & _
                                                        Format(checkDate, "mmmm yyyy") & " to " & _
                                                        Format(Date, "mmmm yyyy") & ")"
                                    End If
                            End Select
                        End If
                    Next j

                    ' Write Change in Amount and highlight if non-zero
                    currS = ParseNumber(valsCurr(0))
                    prevS = ParseNumber(valsPrev(0))
                    changeVal = currS - prevS
                    wsReport.Cells(reportRow, changeCol).Value = changeVal
                    If changeVal <> 0 Then wsReport.Cells(reportRow, changeCol).Interior.Color = vbYellow

                    ' Default changeReason if not yet assigned a value
                    If changeReason = "" Then
                        changeReason = "Please investigate further. Relevant changes are highlighted in yellow."
                    End If

                    ' Write constructed Change Reason (if any)
                    wsReport.Cells(reportRow, reasonCol).Value = changeReason

                    ' Mark source
                    wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"

                    reportRow = reportRow + 1
                    changedCount = changedCount + 1
                End If
            End If
        Else
            ' New forecast
            foundRow = FindRowByKey(wsCurr, CStr(dictKey), lastRowCurr)
            If foundRow > 0 Then
                wsReport.Rows(reportRow).Resize(1, colCount).Value = wsCurr.Rows(foundRow).Resize(1, colCount).Value
                ApplyOppHyperlinkToCell wsReport.Cells(reportRow, "D")
                valsCurr = Split(curr(dictKey), "|")
                currS = ParseNumber(valsCurr(0))
                wsReport.Cells(reportRow, changeCol).Value = currS
                If currS <> 0 Then wsReport.Cells(reportRow, changeCol).Interior.Color = vbYellow
                wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"
                reportRow = reportRow + 1
                newCount = newCount + 1
            End If
        End If
    Next dictKey

    ' === Step 2: Forecasts that dropped off ===
    For Each dictKey In prev.Keys
        If Not curr.Exists(dictKey) Then
            foundRow = FindRowByKey(wsPrev, CStr(dictKey), lastRowPrev)
            If foundRow > 0 Then
                ' Copy fallen forecast
                wsReport.Rows(reportRow).Resize(1, colCount).Value = wsPrev.Rows(foundRow).Resize(1, colCount).Value
                ApplyOppHyperlinkToCell wsReport.Cells(reportRow, "D")
                wsReport.Rows(reportRow).Interior.Color = RGB(120, 120, 120)  ' grey row
                wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"

                ' Get prev forecast amount and mark as negative (keep using X as you intended)
                Dim prevAmt As Variant
                prevAmt = wsReport.Cells(reportRow, "X").Value
                If IsNumeric(prevAmt) Then
                    wsReport.Cells(reportRow, changeCol).Value = -ParseNumber(prevAmt)
                End If

                reportRow = reportRow + 1
                removedCount = removedCount + 1

                ' Add Actuals lines (still yellow highlight for those)
                Dim oppId As String, revStream As String, errUser As String, gidbCo As String
                Dim iAct As Long, lastColAct As Long
                Dim actAmt As Variant

                oppId = Trim(wsPrev.Cells(foundRow, "D").Value)
                revStream = Trim(wsPrev.Cells(foundRow, "P").Value)
                errUser = Trim(wsPrev.Cells(foundRow, "K").Value)
                gidbCo = Trim(wsPrev.Cells(foundRow, "J").Value)

                ' === Build normalized keys once for the dropped forecast ===
                Dim keyOppPrev As String, keyEUPrev As String, keyGIDBPrev As String
                keyOppPrev = CleanString(oppId) & "_" & CleanString(revStream)
                keyEUPrev = CleanString(errUser) & "_" & CleanString(revStream)
                keyGIDBPrev = CleanString(gidbCo) & "_" & CleanString(revStream)

                ' === Require Year/Quarter/Month match (Prev AA vs Actuals AT) ===
                Dim keyPeriodPrev As String
                keyPeriodPrev = CleanString(wsPrev.Cells(foundRow, "AA").Value)

                For iAct = 2 To lastRowCurrAct
                    ' === Normalize actuals keys too (fixes hidden chars/case/NBSP) ===
                    Dim keyOppAct As String, keyEUAct As String, keyGIDBAct As String
                    keyOppAct = CleanString(wsCurrAct.Cells(iAct, "T").Value) & "_" & CleanString(wsCurrAct.Cells(iAct, "AI").Value)
                    keyEUAct = CleanString(wsCurrAct.Cells(iAct, "AD").Value) & "_" & CleanString(wsCurrAct.Cells(iAct, "AI").Value)
                    keyGIDBAct = CleanString(wsCurrAct.Cells(iAct, "AC").Value) & "_" & CleanString(wsCurrAct.Cells(iAct, "AI").Value)

                    ' === Actuals period key (Actuals AT) ===
                    Dim keyPeriodAct As String
                    keyPeriodAct = CleanString(wsCurrAct.Cells(iAct, "AT").Value)

                    ' === Match by (Opp OR EndUser OR GIDB) AND same period ===
                    If ((keyOppAct = keyOppPrev) Or (keyEUAct = keyEUPrev) Or (keyGIDBAct = keyGIDBPrev)) _
                        And (keyPeriodAct = keyPeriodPrev) Then

                        lastColAct = wsCurrAct.Cells(iAct, wsCurrAct.Columns.Count).End(xlToLeft).Column
                        wsReport.Cells(reportRow, 1).Resize(1, lastColAct - 19 + 1).Value = _
                            wsCurrAct.Cells(iAct, 20).Resize(1, lastColAct - 19 + 1).Value

                        ApplyOppHyperlinkToCell wsReport.Cells(reportRow, "D")

                        actAmt = wsReport.Cells(reportRow, "X").Value
                        If IsNumeric(actAmt) Then
                            wsReport.Cells(reportRow, changeCol).Value = ParseNumber(actAmt)
                            If ParseNumber(actAmt) <> 0 Then wsReport.Cells(reportRow, changeCol).Interior.Color = vbYellow
                        End If

                        wsReport.Cells(reportRow, reasonCol + 1).Value = "Actuals"
                        reportRow = reportRow + 1
                        removedCount = removedCount + 1
                    End If
                Next iAct
            End If
        End If
    Next dictKey

    wsReport.Columns.AutoFit

    Call AppendManAdjToReport

    ThisWorkbook.Sheets("Summary") _
        .PivotTables("CoCLF").RefreshTable

    MsgBox "Report has been updated.", vbInformation, "Process Complete"
End Sub

Function FindRowByKey(ws As Worksheet, ByVal keyText As String, ByVal lastRow As Long) As Long
    Dim i As Long, testKey As String
    For i = 2 To lastRow
        testKey = Trim$(CStr(ws.Cells(i, "D").Value)) & "_" & Trim$(CStr(ws.Cells(i, "P").Value))
        If testKey = keyText Then
            FindRowByKey = i
            Exit Function
        End If
    Next i
    FindRowByKey = 0
End Function

Private Function ParseNumber(ByVal v As Variant) As Double
    Dim s As String
    s = Trim$(CStr(v))
    If s = "" Or UCase$(s) = "N/A" Then
        ParseNumber = 0
    Else
        s = Replace(s, ",", "")
        s = Replace(s, "$", "")
        On Error Resume Next
        ParseNumber = CDbl(s)
        On Error GoTo 0
    End If
End Function

Private Function CleanString(ByVal s As Variant) As String
    Dim temp As String
    temp = Trim(CStr(s))
    temp = Replace(temp, Chr(160), "")
    CleanString = UCase(temp)
End Function

' Edit link below
Private Sub ApplyOppHyperlinkToCell(ByVal targetCell As Range)
    Const URL_PREFIX As String = "https://orion.sas.com/opportunities/"
    Const URL_SUFFIX As String = "/overview"
    Dim oppId As String, linkAddress As String
    oppId = Trim$(CStr(targetCell.Value))
    If oppId = "" Or UCase$(oppId) = "N/A" Then Exit Sub

    linkAddress = URL_PREFIX & oppId & URL_SUFFIX

    On Error Resume Next
    targetCell.Hyperlinks.Delete
    On Error GoTo 0

    targetCell.Parent.Hyperlinks.Add _
        Anchor:=targetCell, _
        Address:=linkAddress, _
        TextToDisplay:=oppId
End Sub
