Option Explicit

Sub BuildPrevAndCurrDictionaries()
    Dim wsPrev As Worksheet, wsCurr As Worksheet, wsCurrActuals As Worksheet
    Dim lastRowPrev As Long, lastRowCurr As Long, lastRowCurrAct As Long
    Dim prevDict As Object, currDict As Object, actDict As Object
    Dim key As String, i As Long
    
    ' Define sheets
    Set wsPrev = ThisWorkbook.Sheets("PrevOpps")
    Set wsCurr = ThisWorkbook.Sheets("CurrOpps")
    Set wsCurrActuals = ThisWorkbook.Sheets("CurrActuals")
    
    ' Create dictionaries
    Set prevDict = CreateObject("Scripting.Dictionary")
    Set currDict = CreateObject("Scripting.Dictionary")
    Set actDict = CreateObject("Scripting.Dictionary")
    
    ' Find last rows
    lastRowPrev = wsPrev.Cells(wsPrev.Rows.Count, "A").End(xlUp).Row
    lastRowCurr = wsCurr.Cells(wsCurr.Rows.Count, "A").End(xlUp).Row
    lastRowCurrAct = wsCurrActuals.Cells(wsCurrActuals.Rows.Count, "T").End(xlUp).Row
    
    ' === Build PrevOpps dictionary ===
    For i = 2 To lastRowPrev
        If Trim(wsPrev.Cells(i, "A").Value) <> "" Then
            key = Trim(wsPrev.Cells(i, "A").Value) & "_" & Trim(wsPrev.Cells(i, "P").Value)
        Else
            key = Trim(wsPrev.Cells(i, "K").Value) & "_" & Trim(wsPrev.Cells(i, "P").Value)
        End If
        prevDict(key) = i
    Next i
    
    ' === Build CurrOpps dictionary ===
    For i = 2 To lastRowCurr
        If Trim(wsCurr.Cells(i, "A").Value) <> "" Then
            key = Trim(wsCurr.Cells(i, "A").Value) & "_" & Trim(wsCurr.Cells(i, "P").Value)
        Else
            key = Trim(wsCurr.Cells(i, "K").Value) & "_" & Trim(wsCurr.Cells(i, "P").Value)
        End If
        currDict(key) = i
    Next i
    
    ' === Build CurrActuals dictionary ===
    For i = 2 To lastRowCurrAct
        If Trim(wsCurrActuals.Cells(i, "T").Value) <> "" Then
            key = Trim(wsCurrActuals.Cells(i, "T").Value) & "_" & Trim(wsCurrActuals.Cells(i, "AI").Value)
        Else
            key = Trim(wsCurrActuals.Cells(i, "AD").Value) & "_" & Trim(wsCurrActuals.Cells(i, "AI").Value)
        End If
        actDict(key) = i
    Next i
    
    ' Call main comparison
    CheckDictionaries prevDict, currDict, actDict
End Sub


Sub CheckDictionaries(prev As Object, curr As Object, actDict As Object)
    Dim wsPrev As Worksheet, wsCurr As Worksheet, wsCurrActuals As Worksheet, wsReport As Worksheet
    Dim lastRowPrev As Long, lastRowCurr As Long, colCount As Long
    Dim dictKey As Variant, foundRow As Long, reportRow As Long
    Dim valsPrev() As String, valsCurr() As String
    Dim prevS As Double, currS As Double
    Dim changeCol As Long, reasonCol As Long
    Dim oppID As String, revStream As String, endUser As String
    Dim actKey As String, actRow As Long
    
    ' Define sheets
    Set wsPrev = ThisWorkbook.Sheets("PrevOpps")
    Set wsCurr = ThisWorkbook.Sheets("CurrOpps")
    Set wsCurrActuals = ThisWorkbook.Sheets("CurrActuals")
    Set wsReport = ThisWorkbook.Sheets("Report")
    
    ' Setup columns
    wsReport.Cells.ClearContents
    colCount = wsCurr.Cells(1, wsCurr.Columns.Count).End(xlToLeft).Column
    wsCurr.Rows(1).Resize(1, colCount).Copy wsReport.Rows(1)
    reportRow = 2
    changeCol = colCount + 1
    reasonCol = colCount + 2
    
    wsReport.Cells(1, changeCol).Value = "Change"
    wsReport.Cells(1, reasonCol).Value = "Reason"
    wsReport.Cells(1, colCount + 3).Value = "Source"
    
    lastRowPrev = wsPrev.Cells(wsPrev.Rows.Count, "A").End(xlUp).Row
    lastRowCurr = wsCurr.Cells(wsCurr.Rows.Count, "A").End(xlUp).Row
    
    ' === Step 1: Rows in CurrOpps ===
    For Each dictKey In curr.Keys
        foundRow = FindRowByKey(wsCurr, CStr(dictKey), lastRowCurr)
        If foundRow > 0 Then
            wsReport.Rows(reportRow).Resize(1, colCount).Value = _
                wsCurr.Rows(foundRow).Resize(1, colCount).Value
            wsReport.Cells(reportRow, reasonCol).Value = "Forecast"
            wsReport.Cells(reportRow, colCount + 3).Value = "Forecast"
            reportRow = reportRow + 1
        End If
    Next dictKey
    
    ' === Step 2: Rows in PrevOpps but not in CurrOpps ===
    For Each dictKey In prev.Keys
        If Not curr.Exists(dictKey) Then
            foundRow = FindRowByKey(wsPrev, CStr(dictKey), lastRowPrev)
            If foundRow > 0 Then
                oppID = Trim(wsPrev.Cells(foundRow, "A").Value)
                revStream = Trim(wsPrev.Cells(foundRow, "P").Value)
                endUser = Trim(wsPrev.Cells(foundRow, "K").Value)
                
                ' Primary or fallback key
                If oppID <> "" Then
                    actKey = oppID & "_" & revStream
                Else
                    actKey = endUser & "_" & revStream
                End If
                
                ' Check if found in CurrActuals
                If actDict.Exists(actKey) Then
                    actRow = actDict(actKey)
                    
                    ' Find corresponding row in CurrOpps to copy data starting at column T
                    Dim foundCurrRow As Long
                    foundCurrRow = FindRowByKey(wsCurr, CStr(dictKey), lastRowCurr)
                    
                    If foundCurrRow > 0 Then
                        Dim lastColCurr As Long
                        lastColCurr = wsCurr.Cells(1, wsCurr.Columns.Count).End(xlToLeft).Column
                        
                        ' Copy from CurrOpps columns T → end into Report columns A → ...
                        wsReport.Cells(reportRow, "A").Resize(1, lastColCurr - 19 + 1).Value = _
                            wsCurr.Cells(foundCurrRow, "T").Resize(1, lastColCurr - 19 + 1).Value
                    Else
                        ' Fallback: copy from CurrActuals if CurrOpps row not found
                        wsReport.Rows(reportRow).Resize(1, colCount).Value = _
                            wsCurrActuals.Rows(actRow).Resize(1, colCount).Value
                    End If
                    
                    wsReport.Cells(reportRow, reasonCol).Value = "Invoiced in Actuals"
                    wsReport.Cells(reportRow, colCount + 3).Value = "Actuals"
                    wsReport.Rows(reportRow).Interior.Color = RGB(198, 239, 206) ' light green
                Else
                    ' Not invoiced, normal removed case
                    wsReport.Rows(reportRow).Resize(1, colCount).Value = _
                        wsPrev.Rows(foundRow).Resize(1, colCount).Value
                    wsReport.Rows(reportRow).Interior.Color = RGB(120, 120, 120) ' gray
                    wsReport.Cells(reportRow, reasonCol).Value = "Removed (no invoicing found)"
                    wsReport.Cells(reportRow, colCount + 3).Value = "Forecast"
                End If
                
                reportRow = reportRow + 1
            End If
        End If
    Next dictKey
    
    MsgBox "Comparison complete.", vbInformation
End Sub


Function FindRowByKey(ws As Worksheet, key As String, lastRow As Long) As Long
    Dim i As Long, buildKey As String
    For i = 2 To lastRow
        If Trim(ws.Cells(i, "A").Value) <> "" Then
            buildKey = Trim(ws.Cells(i, "A").Value) & "_" & Trim(ws.Cells(i, "P").Value)
        Else
            buildKey = Trim(ws.Cells(i, "K").Value) & "_" & Trim(ws.Cells(i, "P").Value)
        End If
        If buildKey = key Then
            FindRowByKey = i
            Exit Function
        End If
    Next i
    FindRowByKey = 0
End Function
