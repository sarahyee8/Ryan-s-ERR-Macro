Sub BuildPrevAndCurrDictionaries()
    Dim wsPrev As Worksheet, wsCurr As Worksheet
    Dim wsPrevAct As Worksheet, wsCurrAct As Worksheet
    Dim lastRowPrev As Long, lastRowCurr As Long
    Dim lastRowPrevAct As Long, lastRowCurrAct As Long
    Dim i As Long
    Dim key As String, valueStr As String
    Dim prev As Object, curr As Object
    Dim dictKey As Variant

    ' Create dictionaries
    Set prev = CreateObject("Scripting.Dictionary")
    Set curr = CreateObject("Scripting.Dictionary")

    ' Set worksheets
    Set wsPrev = ThisWorkbook.Sheets("PrevOpps")
    Set wsCurr = ThisWorkbook.Sheets("CurrOpps")
    Set wsPrevAct = ThisWorkbook.Sheets("PrevActuals")
    Set wsCurrAct = ThisWorkbook.Sheets("CurrActuals")

    ' Find last rows
    lastRowPrev = wsPrev.Cells(wsPrev.Rows.Count, "D").End(xlUp).Row
    lastRowCurr = wsCurr.Cells(wsCurr.Rows.Count, "D").End(xlUp).Row
    lastRowPrevAct = wsPrevAct.Cells(wsPrevAct.Rows.Count, "T").End(xlUp).Row
    lastRowCurrAct = wsCurrAct.Cells(wsCurrAct.Rows.Count, "T").End(xlUp).Row

    ' === Build prev dictionary ===
    For i = 2 To lastRowPrev
        key = Trim(wsPrev.Cells(i, "D").Value) & "_" & Trim(wsPrev.Cells(i, "P").Value)
        valueStr = Join(Array( _
                      ParseNumber(wsPrev.Cells(i, "S").Value), _
                      CleanString(wsPrev.Cells(i, "K").Value), _
                      CleanString(wsPrev.Cells(i, "W").Value), _
                      CleanString(wsPrev.Cells(i, "T").Value), _
                      CleanString(wsPrev.Cells(i, "O").Value), _
                      CleanString(wsPrev.Cells(i, "G").Value), _
                      CleanString(wsPrev.Cells(i, "AA").Value)), "|")
        prev(key) = valueStr
    Next i

    ' === Build curr dictionary ===
    For i = 2 To lastRowCurr
        key = Trim(wsCurr.Cells(i, "D").Value) & "_" & Trim(wsCurr.Cells(i, "P").Value)
        valueStr = Join(Array( _
                      ParseNumber(wsCurr.Cells(i, "S").Value), _
                      CleanString(wsCurr.Cells(i, "K").Value), _
                      CleanString(wsCurr.Cells(i, "W").Value), _
                      CleanString(wsCurr.Cells(i, "T").Value), _
                      CleanString(wsCurr.Cells(i, "O").Value), _
                      CleanString(wsCurr.Cells(i, "G").Value), _
                      CleanString(wsCurr.Cells(i, "AA").Value)), "|")
        curr(key) = valueStr
    Next i

    ' Call comparison procedure
    Call CheckDictionaries(prev, curr, wsPrev, wsCurr, wsPrevAct, wsCurrAct)
End Sub


Sub CheckDictionaries(prev As Object, curr As Object, _
                      wsPrev As Worksheet, wsCurr As Worksheet, _
                      wsPrevAct As Worksheet, wsCurrAct As Worksheet)
    Dim wsReport As Worksheet
    Dim dictKey As Variant
    Dim reportRow As Long
    Dim valsPrev As Variant, valsCurr As Variant
    Dim foundRow As Long, foundRowAct As Long
    Dim lastRowPrev As Long, lastRowCurr As Long, lastRowCurrAct As Long
    Dim colCount As Long, colCountAct As Long
    Dim j As Long, maxIdx As Long
    Dim prevS As Double, currS As Double, changeVal As Double
    Dim prevVal As String, currVal As String
    Dim changedCount As Long, newCount As Long, removedCount As Long
    Dim changeReason As String
    Dim key As String, oppId As String, revStream As String
    Dim errEndUser As String
    Dim foundInActuals As Boolean
    Dim changeCol As Long, reasonCol As Long

    ' Initialize
    changedCount = 0: newCount = 0: removedCount = 0
    colCount = wsPrev.Cells(1, wsPrev.Columns.Count).End(xlToLeft).Column
    colCountAct = wsCurrAct.Cells(1, wsCurrAct.Columns.Count).End(xlToLeft).Column
    lastRowPrev = wsPrev.Cells(wsPrev.Rows.Count, "D").End(xlUp).Row
    lastRowCurr = wsCurr.Cells(wsCurr.Rows.Count, "D").End(xlUp).Row
    lastRowCurrAct = wsCurrAct.Cells(wsCurrAct.Rows.Count, "T").End(xlUp).Row

    ' Create/clear Report
    On Error Resume Next
    Set wsReport = ThisWorkbook.Sheets("Report")
    On Error GoTo 0
    If wsReport Is Nothing Then
        Set wsReport = ThisWorkbook.Sheets.Add
        wsReport.Name = "Report"
    Else
        wsReport.Cells.Clear
    End If

    ' Header
    wsPrev.Rows(1).Resize(1, colCount).Copy wsReport.Rows(1)
    changeCol = colCount + 1
    reasonCol = colCount + 2
    wsReport.Cells(1, changeCol).Value = "Change in Amount"
    wsReport.Cells(1, reasonCol).Value = "Change Reason"
    wsReport.Cells(1, reasonCol + 1).Value = "Source"
    reportRow = 2

    ' === Step 1: Loop through keys in curr ===
    For Each dictKey In curr.Keys
        If prev.Exists(dictKey) Then
            If prev(dictKey) <> curr(dictKey) Then
                foundRow = FindRowByKey(wsCurr, CStr(dictKey), lastRowCurr)
                If foundRow > 0 Then
                    wsReport.Rows(reportRow).Resize(1, colCount).Value = _
                        wsCurr.Rows(foundRow).Resize(1, colCount).Value

                    valsPrev = Split(prev(dictKey), "|")
                    valsCurr = Split(curr(dictKey), "|")
                    maxIdx = UBound(valsCurr)
                    If UBound(valsPrev) < maxIdx Then maxIdx = UBound(valsPrev)
                    changeReason = ""

                    For j = 0 To maxIdx
                        If j = 0 Then
                            prevVal = CStr(ParseNumber(valsPrev(j)))
                            currVal = CStr(ParseNumber(valsCurr(j)))
                        Else
                            prevVal = CleanString(valsPrev(j))
                            currVal = CleanString(valsCurr(j))
                        End If
                        If currVal <> prevVal Then
                            changeVal = ParseNumber(valsCurr(0)) - ParseNumber(valsPrev(0))
                            Select Case j
                                Case 0: wsReport.Cells(reportRow, 19).Interior.Color = vbYellow
                                Case 1: wsReport.Cells(reportRow, 23).Interior.Color = vbYellow
                                Case 2: wsReport.Cells(reportRow, 20).Interior.Color = vbYellow
                                Case 3: wsReport.Cells(reportRow, 15).Interior.Color = vbYellow
                                Case 4: wsReport.Cells(reportRow, 7).Interior.Color = vbYellow
                                Case 5: wsReport.Cells(reportRow, 27).Interior.Color = vbYellow
                            End Select
                        End If
                    Next j

                    currS = ParseNumber(valsCurr(0))
                    prevS = ParseNumber(valsPrev(0))
                    changeVal = currS - prevS
                    wsReport.Cells(reportRow, changeCol).Value = changeVal
                    wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"
                    reportRow = reportRow + 1
                    changedCount = changedCount + 1
                End If
            End If
        Else
            ' New row
            foundRow = FindRowByKey(wsCurr, CStr(dictKey), lastRowCurr)
            If foundRow > 0 Then
                wsReport.Rows(reportRow).Resize(1, colCount).Value = _
                    wsCurr.Rows(foundRow).Resize(1, colCount).Value
                wsReport.Cells(reportRow, changeCol).Value = ParseNumber(wsCurr.Cells(foundRow, "S").Value)
                wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"
                reportRow = reportRow + 1
                newCount = newCount + 1
            End If
        End If
    Next dictKey

    ' === Step 2: Rows in prev missing from curr (check if invoiced in Actuals) ===
    For Each dictKey In prev.Keys
        If Not curr.Exists(dictKey) Then
            ' Extract ID + rev stream + end user
            oppId = Trim$(Split(dictKey, "_")(0))
            revStream = Trim$(Split(dictKey, "_")(1))
            foundInActuals = False

            ' Try Opp ID + Rev Stream
            For i = 2 To lastRowCurrAct
                If Trim$(wsCurrAct.Cells(i, "T").Value) = oppId And _
                   Trim$(wsCurrAct.Cells(i, "AI").Value) = revStream Then
                    foundInActuals = True
                    foundRowAct = i
                    Exit For
                End If
            Next i

            ' If not found, try ERR End User + Rev Stream
            If Not foundInActuals Then
                errEndUser = Trim$(wsPrev.Cells(FindRowByKey(wsPrev, dictKey, lastRowPrev), "K").Value)
                For i = 2 To lastRowCurrAct
                    If Trim$(wsCurrAct.Cells(i, "AD").Value) = errEndUser And _
                       Trim$(wsCurrAct.Cells(i, "AI").Value) = revStream Then
                        foundInActuals = True
                        foundRowAct = i
                        Exit For
                    End If
                Next i
            End If

            If foundInActuals Then
                wsReport.Rows(reportRow).Resize(1, colCountAct).Value = _
                    wsCurrAct.Rows(foundRowAct).Resize(1, colCountAct).Value
                wsReport.Cells(reportRow, reasonCol + 1).Value = "Actuals"
                reportRow = reportRow + 1
            Else
                foundRow = FindRowByKey(wsPrev, CStr(dictKey), lastRowPrev)
                If foundRow > 0 Then
                    wsReport.Rows(reportRow).Resize(1, colCount).Value = _
                        wsPrev.Rows(foundRow).Resize(1, colCount).Value
                    wsReport.Rows(reportRow).Interior.Color = RGB(120, 120, 120)
                    wsReport.Cells(reportRow, reasonCol + 1).Value = "Forecast"
                    reportRow = reportRow + 1
                    removedCount = removedCount + 1
                End If
            End If
        End If
    Next dictKey

    wsReport.Columns.AutoFit
End Sub


Function FindRowByKey(ws As Worksheet, ByVal keyText As String, ByVal lastRow As Long) As Long
    Dim i As Long, testKey As String
    For i = 2 To lastRow
        testKey = Trim$(CStr(ws.Cells(i, "D").Value)) & "_" & Trim$(CStr(ws.Cells(i, "P").Value))
        If testKey = keyText Then
            FindRowByKey = i
            Exit Function
        End If
    Next i
    FindRowByKey = 0
End Function


Private Function ParseNumber(ByVal v As Variant) As Double
    Dim s As String
    s = Trim$(CStr(v))
    If s = "" Or UCase$(s) = "N/A" Then
        ParseNumber = 0
    Else
        s = Replace(s, ",", "")
        s = Replace(s, "$", "")
        On Error Resume Next
        ParseNumber = CDbl(s)
        On Error GoTo 0
    End If
End Function


Private Function CleanString(ByVal s As Variant) As String
    Dim temp As String
    temp = Trim(CStr(s))
    temp = Replace(temp, Chr(160), "")
    CleanString = UCase(temp)
End Function
